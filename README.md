# دمو سامانه تصمیم‌یار آب زیرزمینی (یاسوج)

این مخزن یک **دمو کامل** از سامانه تصمیم‌یار آب زیرزمینی است که با **داده‌های دمو (Seed)**، **Backend API واقعی**، **کنترل دسترسی نقش‌محور (RBAC)**، **لاگ ممیزی (Audit Logs)**، **رابط کاربری فارسی و راست‌به‌چپ (RTL)**، **تقویم شمسی** و **دستیار پروژه (پاپ‌آپ)** اجرا می‌شود.

## امکانات

- **داشبورد**: کارت‌های شاخص، روند سطح آب + خط روند، نمودار اقلیم (بارش/دما)، پیش‌بینی با باند عدم‌قطعیت (صدک‌های ۱۰/۵۰/۹۰)، ماتریس ریسک، ۱۰ چاه پرریسک، خوراک فعالیت‌ها و پیش‌نمایش اعلان‌ها.
- **پایش چاه‌ها**: لیست چاه‌ها با فیلتر/جستجو/خروجی + صفحه جزئیات (تب‌های سری زمانی، کیفیت، پیش‌بینی‌ها و یادداشت‌ها).
- **دیتاست‌ها** (تحلیلگر/مدیر): ساخت/ویرایش، آپلود، اعتبارسنجی، انتشار.
- **سناریوهای اقلیمی** (تحلیلگر/مدیر): لیست، ایجاد، اجرای کار، نتایج و دانلودها.
- **مدل‌ها** (تحلیلگر/مدیر): رجیستری، آموزش به صورت کار، متریک‌ها و نمودارها، فعال‌سازی/بازگشت نسخه (دمو).
- **پیش‌بینی‌ها**: ویزارد اجرا (سناریو/مدل/چاه‌ها/افق) + نتایج و خروجی‌ها.
- **هشدارها** (تحلیلگر/مدیر): قانون‌ساز، لیست، تست/غیرفعال‌سازی، تاریخچه فعال‌شدن.
- **اعلان‌ها**: همه/خوانده‌نشده، خوانده‌شدن.
- **گزارش‌ها**: ویزارد تولید گزارش + فایل‌های نمونه آماده دانلود.
- **مدیریت**: مدیریت کاربران، تنظیمات سازمان، لاگ ممیزی. (ابرمدیر: مدیریت سازمان‌ها)
- **دستیار پروژه (پاپ‌آپ)**: فقط درباره همین دمو پاسخ می‌دهد و پاسخ مالکیت را به صورت ثابت اعمال می‌کند.

## نقش‌ها (RBAC)

منوها بر اساس نقش نمایش داده می‌شوند:

- عمومی: داشبورد، پایش چاه‌ها، پیش‌بینی‌ها، اعلان‌ها، گزارش‌ها، تنظیمات پروفایل
- تحلیلگر/مدیر: دیتاست‌ها، سناریوهای اقلیمی، مدل‌ها، هشدارها
- مدیر سازمان/ابرمدیر: مدیریت کاربران، تنظیمات سازمان، لاگ ممیزی
- ابرمدیر: مدیریت سازمان‌ها

## حساب‌های دمو

رمز همه کاربران دمو:

- رمز: `Password123!`
- کاربران:
  - `viewer@demo.local` (بیننده)
  - `analyst@demo.local` (تحلیلگر)
  - `admin@demo.local` (مدیر)
  - `orgadmin@demo.local` (مدیر سازمان)
  - `superadmin@demo.local` (ابرمدیر)

ورود خودکار برای تست سریع (اختیاری):

- مسیر: `/demo-autologin.html`
- نمونه: `http://SERVER_IP:5173/demo-autologin.html?as=viewer&next=/dashboard`
- نقش‌ها: `viewer`، `analyst`، `admin`، `org_admin`، `super_admin`

## داده‌های دمو (Seed)

در اولین اجرای API، داده‌ها به صورت خودکار ساخته می‌شوند:

- ۱ سازمان، ۵ کاربر (طبق نقش‌ها)
- ۳ دشت، ۶ آبخوان
- **۳۰ چاه** در دشت‌ها
- **۶۰ نقطه ماهانه برای هر چاه** (۵ سال)
- ریسک از «روند افت + کیفیت داده» ساخته می‌شود (منطق دمو)
- پیش‌بینی‌ها شامل **صدک‌های ۱۰/۵۰/۹۰** هستند
- ۲۰+ اعلان
- ۵۰+ لاگ ممیزی
- ۵ فایل گزارش نمونه (در پوشه ذخیره‌سازی API)

## اجرای محلی (Node.js)

پیش‌نیاز:

- Node.js نسخه `20+`

اجرا:

```bash
cd /home/ubuntu/Desktop/yasooj-water
npm install
npm run dev
```

آدرس‌ها:

- وب: `http://localhost:5173`
- API: `http://localhost:8080`
- مستندات سرویس (Swagger/OpenAPI): `http://localhost:8080/docs`

نکته: برای دسترسی از گوشی/دستگاه دیگر، از IP یا دامنه سرور استفاده کنید (مثال: `http://SERVER_IP:5173`). رابط وب همه درخواست‌های API را به صورت نسبی از مسیر `/api` ارسال می‌کند.

## اجرای داکر (docker-compose)

```bash
cd /home/ubuntu/Desktop/yasooj-water
docker compose up
```

سپس:

- وب: `http://localhost:5173`
- API: `http://localhost:8080`
- مستندات سرویس: `http://localhost:8080/docs`

## قرارداد پاسخ API

همه endpointها یک استاندارد ثابت دارند:

- Success:

```json
{ "data": "...", "meta": { "requestId": "..." } }
```

- Error:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input",
    "details": [{ "field": "email", "issue": "invalid_format" }]
  },
  "meta": { "requestId": "..." }
}
```

صفحه‌بندی داخل `data` برمی‌گردد:

```json
{ "items": [], "page": 1, "pageSize": 20, "total": 135, "sort": "createdAt:desc" }
```

کارها (Job) برای جریان‌های دمو (آموزش مدل، اجرای سناریو، اجرای پیش‌بینی، تولید گزارش) شبیه‌سازی شده‌اند.

## تنظیمات (Env)

- API: `apps/api/.env.example`
- وب: `apps/web/.env.example`

## ریست داده‌های دمو

برای ساخت دوباره داده‌های Seed:

```bash
rm -f apps/api/storage/db.json
```

سپس API را دوباره اجرا کنید.

## تست‌ها

تست‌های Backend:

```bash
npm test
```

تست دود (Smoke) رابط کاربری (برای بررسی RTL + نبودن اسکرول افقی در صفحات):

1) ابتدا سرویس‌ها را اجرا کنید:

```bash
npm run dev
```

2) سپس در یک ترمینال دیگر:

```bash
npm run ui:smoke
```

خروجی اسکرین‌شات‌ها (در حالت fail) در `tmp/screens/ui-smoke` ذخیره می‌شود.

## بیلد

```bash
npm run build
```

اجرای بعد از بیلد:

- API: `npm -w apps/api run start`
- وب (پیش‌نمایش): `npm -w apps/web run preview`

## مالکیت

مالکیت و حقوق این سامانه متعلق به شرکت شبکه هوشمند ابتکار ویستا است.
